# 多 API 地址管理架构图

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                         用户界面层                            │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────┐  ┌──────────────────┐                │
│  │ MultiKeyManager  │  │  DroidKeyModal   │                │
│  │                  │  │                  │                │
│  │ • 显示多个 Keys  │  │ • 添加/编辑 Key  │                │
│  │ • 显示延迟信息   │  │ • 配置 API 地址  │                │
│  │ • 批量测速按钮   │  │ • 预设地址选择   │                │
│  │ • 切换策略选择   │  │ • 批量导入      │                │
│  └──────────────────┘  └──────────────────┘                │
│                                                               │
│  ┌──────────────────────────────────────────┐               │
│  │         EndpointSpeedTest (复用)          │               │
│  │                                           │               │
│  │ • 测速核心逻辑                             │               │
│  │ • 并行测试                                │               │
│  │ • 结果缓存                                │               │
│  └──────────────────────────────────────────┘               │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                         数据管理层                            │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────────────────────────────┐               │
│  │            DroidProvider                  │               │
│  │                                           │               │
│  │  api_keys: [                             │               │
│  │    {                                      │               │
│  │      id: "key1",                         │               │
│  │      key: "fk-xxx",                      │               │
│  │      name: "主力",                       │               │
│  │      base_url: "https://api.xxx",  ←─────│─── 新增       │
│  │      latency: 45,                  ←─────│─── 新增       │
│  │      last_tested: 1709000000,      ←─────│─── 新增       │
│  │      status: "online",             ←─────│─── 新增       │
│  │      balance: {...}                      │               │
│  │    }                                      │               │
│  │  ]                                        │               │
│  │  switch_strategy: "use_fastest"    ←─────│─── 新增策略    │
│  └──────────────────────────────────────────┘               │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                          API 层                              │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   API Key 1  │  │   API Key 2  │  │   API Key 3  │      │
│  │              │  │              │  │              │      │
│  │ api.anthro.. │  │ api.claude.. │  │ proxy.exam.. │      │
│  │   45ms ✅    │  │   120ms ✅   │  │   500ms ⚠️   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│         ↓                  ↓                  ↓              │
│  ┌────────────────────────────────────────────────────┐     │
│  │              智能路由选择器                          │     │
│  │                                                    │     │
│  │  • 根据策略选择最优 API                             │     │
│  │  • 故障自动转移                                    │     │
│  │  • 负载均衡                                        │     │
│  └────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

## 数据流程图

### 1. 添加 API Key 流程

```
用户输入
    ↓
┌─────────────────┐
│ DroidKeyModal   │
│                 │
│ • Key 名称      │
│ • API Key       │
│ • API 地址      │ ← 新增
└─────────────────┘
    ↓
验证格式
    ↓
保存到 DroidProvider
    ↓
自动测速（可选）
    ↓
更新 UI 显示
```

### 2. 测速流程

```
触发测速
    ↓
┌─────────────────────┐
│  批量测速 / 单个测速  │
└─────────────────────┘
    ↓
并行发送 HEAD 请求
    ↓
┌──────┬──────┬──────┐
│ API1 │ API2 │ API3 │
│ 45ms │120ms │ 超时  │
└──────┴──────┴──────┘
    ↓
更新数据
    ↓
┌─────────────────────┐
│   更新延迟信息       │
│   更新连接状态       │
│   记录测试时间       │
└─────────────────────┘
    ↓
UI 实时更新
    ↓
根据策略自动切换
```

### 3. 智能切换流程

```
请求发起
    ↓
┌─────────────────────┐
│   检查切换策略       │
└─────────────────────┘
    ↓
┌─────────────────────────────────────┐
│         策略判断                      │
├───────────────────────────────────── ┤
│ • manual: 使用当前选中               │
│ • round_robin: 轮询下一个            │
│ • use_fastest: 选择延迟最低          │ ← 新增
│ • use_lowest: 选择余额最低           │
│ • use_highest: 选择余额最高          │
└─────────────────────────────────────┘
    ↓
选择目标 API
    ↓
┌─────────────────────┐
│   健康检查           │
│ • 是否在线           │
│ • 余额是否充足       │
└─────────────────────┘
    ↓
执行请求
    ↓
失败时自动故障转移
```

## UI 组件结构

```
App
 └── DroidProviderList
      └── MultiKeyManager (增强版)
           ├── 批量操作栏
           │    ├── 测试所有按钮
           │    ├── 刷新余额按钮
           │    └── 策略选择器
           │
           ├── API Key 列表
           │    └── KeyCard (每个 Key)
           │         ├── Key 信息
           │         ├── API 地址显示 ← 新增
           │         ├── 延迟显示 ← 新增
           │         ├── 余额信息
           │         ├── 编辑按钮
           │         ├── 测速按钮 ← 新增
           │         └── 删除按钮
           │
           └── 添加 Key 按钮
                └── DroidKeyModal (增强版)
                     ├── Key 名称输入
                     ├── API Key 输入
                     ├── API 地址输入 ← 新增
                     ├── 预设地址选择 ← 新增
                     └── 批量导入
```

## 状态管理

```typescript
// 应用状态
interface AppState {
  providers: DroidProvider[];
  currentProviderId: string;
  testingStatus: Map<string, boolean>;  // 测速状态
  lastTestTime: number;                 // 最后测速时间
}

// 测速缓存
interface SpeedTestCache {
  [keyId: string]: {
    latency: number;
    timestamp: number;
    status: 'online' | 'offline';
  }
}

// 切换决策
interface SwitchDecision {
  targetKeyIndex: number;
  reason: string;  // 切换原因
  metrics: {
    latency?: number;
    balance?: number;
    successRate?: number;
  };
}
```

## 性能优化策略

1. **测速优化**
   - HEAD 请求代替 GET，减少带宽
   - 并行测试，Promise.all 提升效率
   - 结果缓存 30 分钟，避免频繁测试

2. **UI 优化**
   - 虚拟列表渲染（Key 数量多时）
   - 防抖处理用户操作
   - 优化重渲染，使用 memo

3. **数据优化**
   - 增量更新，只改变变化的部分
   - 本地存储测速历史
   - 定期清理过期数据
