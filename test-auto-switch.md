# 测试API Key自动切换功能

## 测试场景

### 1. 余额耗尽自动切换测试
**前置条件**:
- 在Droid模式下配置多个API Keys
- 设置切换策略为"轮询使用"或其他自动策略

**测试步骤**:
1. 添加2个或更多API Keys到同一个Provider
2. 选择一个余额即将耗尽的key作为当前key
3. 观察余额刷新（自动每30秒刷新）
4. 当检测到当前key余额耗尽（余额为0或使用率>99%）时

**预期结果**:
- 系统自动切换到下一个可用的key
- 显示通知："API Key 余额耗尽，已自动切换到 Key X"
- UI更新显示新的当前key
- 余额信息更新为新key的余额

### 2. 单Key模式测试
**前置条件**:
- 设置切换策略为"手动切换"

**测试步骤**:
1. 仅使用单个API Key
2. 手动切换key（如果有多个）

**预期结果**:
- 单key模式下正常工作
- 不会自动切换（即使余额耗尽）
- 需要手动点击切换按钮来更换key

### 3. 切换策略测试
**测试各种切换策略**:
- **手动切换**: 不自动切换，保持单key模式
- **轮询使用**: 余额耗尽后自动切换到下一个key（循环）
- **优先最低**: 自动切换到余额使用率最低的key
- **优先最高**: 自动切换到余额最高的key

### 4. 余额显示更新
**实时余额显示**:
- 模型选择框中显示实时余额：`Sonnet 4.5 [droid] 🟢 19.5M/20M (2%)`
- 颜色指示器:
  - 🟢 绿色：使用率 < 50%
  - 🟡 黄色：使用率 50-80%
  - 🔴 红色：使用率 > 80%

## 已实现的功能

1. ✅ 余额耗尽检测（余额为0或使用率>99%）
2. ✅ 自动切换到下一个key（根据策略）
3. ✅ 通知用户切换成功
4. ✅ 保留单key模式（手动切换策略）
5. ✅ 实时余额显示在模型名称中
6. ✅ 自动刷新余额（每30秒）

## 注意事项

- 自动切换仅在有多个keys且策略不是"手动切换"时触发
- 切换后会自动刷新余额信息
- 所有切换操作都会更新Factory配置
